<!-- Copyright (c) 2020 Jonathan Redpath (legoboyvdlp) -->

<system name="A320: Pressurization">
	<property value="0">/systems/air-conditioning/calculations/mass-flow-total-kg_s</property>
	<property value="0">/systems/pressurization/calculations/outflow-total-kg_s</property>
	<channel name="Pressurization Logic Controller" execrate="8">
		
		<summer name="/systems/pressurization/logic/alt-change-takeoff">
			<input>-/systems/pressurization/logic/takeoff-altitude-ft</input>
			<input>/systems/navigation/adr/computation/baro-alt-corrected-1-capt</input>
		</summer>
		
		<switch name="/systems/pressurization/logic/alt-change-5075">
			<default value="/systems/pressurization/logic/alt-change-5075"/>
			<test logic="AND" value="1">
				/systems/pressurization/logic/alt-change-5075 eq 0
				/systems/pressurization/logic/takeoff-altitude-ft ne -9999
				/systems/pressurization/logic/alt-change-takeoff ge 5075
			</test>
		</switch>
		
		<switch name="/systems/pressurization/logic/gnd-to-takeoff">
			<default value="0"/>
			<test logic="AND" value="1">
				/controls/engines/engine[0]/throttle ge 0.78
				/controls/engines/engine[1]/throttle ge 0.78
				<test logic="OR">
					/gear/gear[1]/wow eq 1
					/gear/gear[2]/wow eq 1
				</test>
			</test>
		</switch>
		
		<switch name="/systems/pressurization/logic/takeoff-to-climb">
			<default value="0"/>
			<test logic="AND" value="1">
				<test logic="OR">
					/systems/navigation/adr/output/tas-1 gt 100
					/systems/navigation/adr/output/tas-2 gt 100
					/systems/navigation/adr/output/tas-3 gt 100
				</test>
				<test logic="OR">
					/gear/gear[1]/wow ne 1
					/gear/gear[2]/wow ne 1
				</test>
			</test>
		</switch>
		
		<switch name="/systems/pressurization/logic/climb-lt-200-30-cmd">
			<default value="0"/>
			<test value="1">
				/instrumentation/gps/indicated-vertical-speed lt 200
			</test>
		</switch>
		
		<actuator name="/systems/pressurization/logic/climb-lt-200-30">
			<input>/systems/pressurization/logic/climb-lt-200-30-cmd</input>
			<rate_limit sense="decr">100</rate_limit>
			<rate_limit sense="incr">0.03333333333</rate_limit>
		</actuator>
		
		<switch name="/systems/pressurization/logic/climb-to-abort">
			<default value="0"/>
			<test logic="AND" value="1">
				/systems/pressurization/logic/climb-lt-200-30 eq 1
				<test logic="OR">
					/systems/navigation/adr/computation/baro-alt-corrected-1-capt lt 8000
					/systems/pressurization/logic/alt-change-5075 eq 0
				</test>
			</test>
		</switch>
		
		<switch name="/systems/pressurization/logic/abort-to-gnd">
			<default value="0"/>
			<test logic="AND" value="1">
				<test logic="OR">
					/gear/gear[1]/wow eq 1
					/gear/gear[2]/wow eq 1
				</test>
				<test logic="OR">
					/systems/navigation/adr/output/tas-1 le 100
					/systems/navigation/adr/output/tas-2 le 100
					/systems/navigation/adr/output/tas-3 le 100
				</test>
			</test>
		</switch>
		
		<switch name="/systems/pressurization/logic/takeoff-to-gnd">
			<default value="0"/>
			<test logic="AND" value="1">
				/controls/engines/engine[0]/throttle lt 0.78
				/controls/engines/engine[1]/throttle lt 0.78
				<test logic="OR">
					/gear/gear[1]/wow eq 1
					/gear/gear[2]/wow eq 1
				</test>
			</test>
		</switch>
		
		<switch name="/systems/pressurization/logic/climb-ge-30-60-cmd">
			<default value="0"/>
			<test value="1">
				/instrumentation/gps/indicated-vertical-speed ge 30
			</test>
		</switch>
		
		<actuator name="/systems/pressurization/logic/climb-ge-30-60">
			<input>/systems/pressurization/logic/climb-ge-30-60-cmd</input>
			<rate_limit sense="decr">100</rate_limit>
			<rate_limit sense="incr">0.01666666666</rate_limit>
		</actuator>
		
		<switch name="/systems/pressurization/logic/abort-to-climb">
			<default value="0"/>
			<test logic="AND" value="1">
				/systems/pressurization/logic/climb-ge-30-60 eq 1
			</test>
		</switch>
		
		<switch name="/systems/pressurization/logic/climb-lt-100-30-cmd">
			<default value="0"/>
			<test value="1">
				/instrumentation/gps/indicated-vertical-speed lt 100
			</test>
		</switch>
		
		<actuator name="/systems/pressurization/logic/climb-lt-100-30">
			<input>/systems/pressurization/logic/climb-lt-100-30-cmd</input>
			<rate_limit sense="decr">100</rate_limit>
			<rate_limit sense="incr">0.03333333333</rate_limit>
		</actuator>
		
		<switch name="/systems/pressurization/logic/climb-to-cruise">
			<default value="0"/>
			<test logic="AND" value="1">
				/systems/navigation/adr/computation/baro-alt-corrected-1-capt ge 8000
				/systems/pressurization/logic/alt-change-5075 eq 1
				/systems/pressurization/logic/climb-lt-100-30 eq 1
			</test>
		</switch>
		
		<switch name="/systems/pressurization/logic/climb-ge-250-60-cmd">
			<default value="0"/>
			<test value="1">
				/instrumentation/gps/indicated-vertical-speed ge 250
			</test>
		</switch>
		
		<actuator name="/systems/pressurization/logic/climb-ge-250-60">
			<input>/systems/pressurization/logic/climb-ge-250-60-cmd</input>
			<rate_limit sense="decr">100</rate_limit>
			<rate_limit sense="incr">0.01666666666</rate_limit>
		</actuator>
		
		<switch name="/systems/pressurization/logic/cruise-to-climb">
			<default value="0"/>
			<test logic="AND" value="1">
				/systems/pressurization/logic/climb-ge-250-60 eq 1
			</test>
		</switch>
		
		<switch name="/systems/pressurization/logic/descent-to-climb">
			<default value="0"/>
			<test logic="AND" value="1">
				/systems/pressurization/logic/climb-ge-250-60 eq 1
			</test>
		</switch>
		
		<switch name="/systems/pressurization/logic/descent-ge-250-30-cmd">
			<default value="0"/>
			<test value="1">
				/instrumentation/gps/indicated-vertical-speed le -250
			</test>
		</switch>
		
		<actuator name="/systems/pressurization/logic/descent-ge-250-30">
			<input>/systems/pressurization/logic/descent-ge-250-30-cmd</input>
			<rate_limit sense="decr">100</rate_limit>
			<rate_limit sense="incr">0.03333333333</rate_limit>
		</actuator>
		
		<switch name="/systems/pressurization/logic/cruise-to-descent">
			<default value="0"/>
			<test logic="AND" value="1">
				/systems/pressurization/logic/descent-ge-250-30 eq 1
			</test>
		</switch>
		
		<switch name="/systems/pressurization/logic/descent-to-gnd">
			<default value="/systems/pressurization/logic/abort-to-gnd"/>
		</switch>
		
		<switch name="/systems/pressurization/logic/climb-to-descent"> <!-- TODO must consider FMGC end of cruise flag. This avoids problem with changing cruise altitude -->
			<default value="/systems/pressurization/logic/cruise-to-descent"/>
		</switch>
		
	</channel>
	
	<channel name="Pressurization Schedules" execrate="8">
	
		<switch name="/systems/pressurization/logic/destination-qnh">
			<default value="1013.125"/>
			<test logic="OR" value="/FMGC/internal/dest-qnh-hpa">
				/FMGC/internal/dest-qnh-hpa ne -1
			</test>
			<test logic="OR" value="/instrumentation/altimeter/setting-hpa"> <!-- todo: check validity of ADIRS info + probably link to FCU code -->
				/FMGC/FCU-working eq 1 <!-- confirm, is altimeter from FCU or where? -->
			</test>
		</switch>
		
		<fcs_function name="/systems/pressurization/logic/landing-elev-knob">
			<function>
				<sum>
					<v>-4000</v>
					<product>
						<v>1000</v>
						<property>/controls/pressurization/ldg-elev</property>
					</product>
				</sum>
			</function>
		</fcs_function>
		
		<switch name="/systems/pressurization/logic/landing-elev">
			<default value="/FMGC/internal/ldg-elev"/>
			<test logic="OR" value="/systems/pressurization/logic/landing-elev-knob">
				/systems/pressurization/active-mode eq 1
				/systems/pressurization/logic/landing-elev-knob ge -2000
			</test>
		</switch>
		
		<fcs_function name="/systems/pressurization/logic/landing-psi-offset">
			<function>
				<product>
					<v>0.0145038</v> <!-- hpa to psi -->
					<difference>
						<property>/systems/pressurization/logic/destination-qnh</property> 
						<v>1013.25</v> <!-- 1012 = -1.25 hpa --> 
					</difference>
				</product>
			</function>	
		</fcs_function>
		
		<fcs_function name="/systems/pressurization/logic/landing-psi">
			<function>
				<sum>
					<property>/systems/pressurization/logic/landing-psi-offset</property>
					<product>
						<v>14.6959488</v>
						<pow>
							<difference>
								<v>1</v>
								<product>
									<v>0.00000687558</v>
									<property>/systems/pressurization/logic/landing-elev</property>
								</product>
							</difference>
							<v>5.25588</v>
						</pow>
					</product>
				</sum>
			</function>
		</fcs_function>
	</channel>
	
	<!-- RPCU commands manual motor to fully open the outflow valve on the ground -->
	<channel name="RPCU" execrate="8">
		
		<switch name="/systems/pressurization/rpcu-command-open">
			<default value="0"/>
			<test logic="AND" value="1">
				/systems/electrical/bus/dc-bat ge 25
				<test logic="OR">
					<test logic="AND">
						/gear/gear[1]/wow eq 1
						/gear/gear[2]/wow eq 1
					</test>
					<test logic="AND">
						<test logic="OR">
							/gear/gear[1]/wow eq 1
							/gear/gear[2]/wow eq 1
						</test>
						/controls/gear/brake-parking eq 1
					</test>
				</test>
				<test logic="OR">
					<test logic="AND">
						/controls/engines/engine[0]/cutoff-switch eq 1
						/controls/engines/engine[1]/cutoff-switch eq 1
					</test>
					<test logic="AND">
						/systems/navigation/adr/output/cas-1 lt 100
						/systems/navigation/adr/output/cas-2 lt 100
						/systems/navigation/adr/output/cas-3 lt 100
					</test>
				</test>
				<test logic="OR">
					/systems/pressurization/active-mode eq 2
					/systems/pressurization/both-cpcs-off eq 1
				</test>
				/systems/pressurization/valves/outflow-valve ne 1.0
			</test>
		</switch>
		
	</channel>
	
	<channel name="Control Logic" execrate="8">
	
		<!-- Ground -->
		<switch name="/systems/pressurization/logic/gnd/active">
			<default value="0"/>
			<test value="1">
				/systems/pressurization/active-phase eq 0
			</test>
		</switch>
		
		<switch name="/systems/pressurization/logic/gnd/target-vs">
			<default value="/systems/pressurization/logic/gnd/max-rate"/>
		</switch>
		
		<fcs_function name="/systems/pressurization/logic/gnd/target-psi">
			<function>
				<product>
					<v>0.491154</v>
					<property>/environment/pressure-inhg</property>
				</product>
			</function>
		</fcs_function>
		
		<fcs_function name="/systems/pressurization/logic/gnd/target-psi-diff">
			<function>
				<difference>
					<property>/systems/pressurization/logic/gnd/target-psi</property>
					<property>/systems/pressurization/cabin-pressure-psi</property>
				</difference>
			</function>
		</fcs_function>
		
		<!-- Takeoff -->
		<switch name="/systems/pressurization/logic/takeoff/active">
			<default value="0"/>
			<test value="1">
				/systems/pressurization/active-phase eq 1
			</test>
		</switch>
		
		<switch name="/systems/pressurization/logic/takeoff/target-vs">
			<default value="/systems/pressurization/logic/takeoff/max-rate"/>
		</switch>
		
		<fcs_function name="/systems/pressurization/logic/takeoff/target-psi">
			<function>
				<sum>
					<v>0.1</v>
					<product>
						<v>0.491154</v>
						<property>/environment/pressure-inhg</property>
					</product>
				</sum>
			</function>
		</fcs_function>
		
		<fcs_function name="/systems/pressurization/logic/takeoff/target-psi-diff">
			<function>
				<difference>
					<property>/systems/pressurization/logic/takeoff/target-psi</property>
					<property>/systems/pressurization/cabin-pressure-psi</property>
				</difference>
			</function>
		</fcs_function>
		
		<!-- Climb -->
		<switch name="/systems/pressurization/logic/climb/active">
			<default value="0"/>
			<test value="1">
				/systems/pressurization/active-phase eq 2
			</test>
		</switch>
		
		<fcs_function name="/systems/pressurization/logic/climb/target-vs">
			<function>
				<product>
					<v>0.19736842105</v>
					<property>/instrumentation/gps/indicated-vertical-speed</property>
				</product>
			</function>
			<clipto>
				<min>0</min>
				<max>/systems/pressurization/logic/climb/max-rate</max>
			</clipto>
		</fcs_function>
		
		<fcs_function name="/systems/pressurization/logic/climb/target-psi">
			<function>
				<difference>
					<product>
						<v>0.491154</v>
						<property>/environment/pressure-inhg</property>
					</product>
					<value>8.06</value>
				</difference>
			</function>
		</fcs_function>
		
		<fcs_function name="/systems/pressurization/logic/climb/target-psi-diff">
			<function>
				<difference>
					<property>/systems/pressurization/logic/climb/target-psi</property>
					<property>/systems/pressurization/cabin-pressure-psi</property>
				</difference>
			</function>
		</fcs_function>
		
		<!-- Abort -->
		<switch name="/systems/pressurization/logic/abort/active">
			<default value="0"/>
			<test value="1">
				/systems/pressurization/active-phase eq 3
			</test>
		</switch>
		
		<fcs_function name="/systems/pressurization/logic/abort/target-vs">
			<function>
				<product>
					<v>0.19736842105</v>
					<property>/instrumentation/gps/indicated-vertical-speed</property>
				</product>
			</function>
			<clipto>
				<min>/systems/pressurization/logic/abort/max-rate</min>
				<max>0</max>
			</clipto>
		</fcs_function>
		
		<fcs_function name="/systems/pressurization/logic/abort/target-psi">
			<function>
				<sum>
					<v>0.1</v>
					<property>/systems/pressurization/logic/takeoff-psi</property>
				</sum>
			</function>
		</fcs_function>
		
		<fcs_function name="/systems/pressurization/logic/abort/target-psi-diff">
			<function>
				<difference>
					<property>/systems/pressurization/logic/abort/target-psi</property>
					<property>/systems/pressurization/cabin-pressure-psi</property>
				</difference>
			</function>
		</fcs_function>
		
		<!-- Cruise -->
		
		<switch name="/systems/pressurization/logic/cruise/active">
			<default value="0"/>
			<test value="1">
				/systems/pressurization/active-phase eq 4
			</test>
		</switch>
		
		<switch name="/systems/pressurization/logic/cruise/target-vs">
			<default value="0"/>
		</switch>
		
		<fcs_function name="/systems/pressurization/logic/cruise/landing-alt-difference">
			<function>
				<difference>
					<!--<property>/systems/pressurization/cabinalt</property>-->
					<value>8000</value>
					<property>/systems/pressurization/logic/landing-elev</property>
				</difference>
			</function>
		</fcs_function>
		
		<fcs_function name="/systems/pressurization/logic/cruise/target-alt-psi">
			<function>
				<sum>
					<product>
						<v>0.00039473684</v>
						<property>/systems/pressurization/logic/cruise/landing-alt-difference</property>
					</product>
					<property>/systems/pressurization/logic/cruise/cabinpsi-memo-cruise</property>
				</sum>
			</function>
		</fcs_function>
		
		<switch name="/systems/pressurization/logic/cruise/target-psi">
			<default value="/systems/pressurization/logic/cruise/cabinpsi-memo-cruise"/>
			<test logic="OR" value="/systems/pressurization/logic/cruise/target-alt-psi">
				/systems/pressurization/logic/cruise/landing-alt-difference le -3800
			</test>
		</switch>
		
		<fcs_function name="/systems/pressurization/logic/cruise/target-psi-diff">
			<function>
				<difference>
					<property>/systems/pressurization/logic/cruise/target-psi</property>
					<property>/systems/pressurization/cabin-pressure-psi</property>
				</difference>
			</function>
		</fcs_function>
		
		<!-- Descent -->
		<switch name="/systems/pressurization/logic/descent/active">
			<default value="0"/>
			<test value="1">
				/systems/pressurization/active-phase eq 5
			</test>
		</switch>
		
		<fcs_function name="/systems/pressurization/logic/descent/target-vs">
			<function>
				<product>
					<v>0.19736842105</v>
					<property>/instrumentation/gps/indicated-vertical-speed</property>
				</product>
			</function>
			<clipto>
				<min>/systems/pressurization/logic/descent/max-rate</min>
				<max>0</max>
			</clipto>
		</fcs_function>
		
		<fcs_function name="/systems/pressurization/logic/descent/target-psi">
			<function>
				<sum>
					<v>0.1</v>
					<property>/systems/pressurization/logic/landing-psi</property>
				</sum>
			</function>
		</fcs_function>
		
		<fcs_function name="/systems/pressurization/logic/descent/target-psi-diff">
			<function>
				<difference>
					<property>/systems/pressurization/logic/descent/target-psi</property>
					<property>/systems/pressurization/cabin-pressure-psi</property>
				</difference>
			</function>
		</fcs_function>
		
		<switch name="/systems/pressurization/logic/outflow-valve-cmd">
			<default value="/systems/pressurization/valves/outflow-valve-cmd"/>
			<test logic="AND" value="1">
				/systems/pressurization/active-phase eq 0
			</test> <!-- should be a 55 sec delay on touchdown, but nvm... -->
		</switch>
		
	</channel>
	
	<channel name="Pressurization Valves" execrate="8">
	
		<switch name="/systems/pressurization/valves/safety-valve">
			<default value="0"/>
			<test logic="OR" value="1"> <!-- near instant, no need for actuator -->
				/systems/pressurization/cabin-delta-p le -1
				/systems/pressurization/cabin-delta-p ge 8.6
			</test>
		</switch>
		
		<switch name="/systems/pressurization/valves/outflow-man-valve-cmd">
			<default value="/systems/pressurization/valves/outflow-man-valve-cmd"/>
			<test logic="OR" value="/systems/pressurization/valves/outflow-valve">
				/systems/pressurization/active-mode ne 2
			</test>
		</switch>
		
		<switch name="/systems/pressurization/valves/outflow-valve-cmd">
			<default value="/systems/pressurization/logic/outflow-valve-cmd"/>
			<test logic="AND" value="0">
				/controls/pressurization/ditching eq 1
			</test>
			<test logic="AND" value="0.5">
				/systems/pressurization/active-mode ne 2
				/controls/pneumatics/switches/ram-air eq 1
				/systems/pressurization/cabin-delta-p lt 1
			</test>
			<test logic="AND" value="0">
				/systems/pressurization/active-mode ne 2
				/systems/pressurization/cabin-pressure-psi lt 8.300505
			</test>
			<test logic="AND" value="1">
				/systems/pressurization/rpcu-command-open eq 1
			</test>
		</switch>
		
		<switch name="/systems/pressurization/valves/outflow-valve-rate">
			<default value="0"/>
			<test logic="AND" value="0.2">
				/systems/pressurization/active-mode ne 2
				/systems/pressurization/active-cpc eq 0
				/systems/electrical/bus/dc-ess ge 25
			</test>
			<test logic="AND" value="0.2"> <!-- via 6PN CB -->
				/systems/pressurization/active-mode ne 2
				/systems/pressurization/active-cpc eq 1
				/systems/electrical/bus/dc-2 ge 25
			</test>
			<test logic="AND" value="0.2"> <!-- via 11PB CB -->
				/systems/pressurization/active-mode eq 2
				/systems/electrical/bus/dc-bat ge 25
			</test>
		</switch>
		
		<actuator name="/systems/pressurization/valves/outflow-valve">
			<input>/systems/pressurization/valves/outflow-valve-cmd</input>
			<rate_limit>/systems/pressurization/valves/outflow-valve-rate</rate_limit>
		</actuator>
		
	</channel>
	
	<channel name="Pressure Calculations" execrate="8">
		
		<fcs_function name="/systems/pressurization/calculations/cabin-mass-kg">
			<function>
				<sum>
					<property>/systems/pressurization/calculations/cabin-mass-init</property>
					<property>/systems/pressurization/calculations/cabin-mass-offset</property>
					<product>
						<property>/systems/pressurization/calculations/outflow-total-kg_s</property>
						<property>simulation/channel-dt</property>
					</product>
				</sum>
			</function>
		</fcs_function>
		
		<fcs_function name="/systems/pressurization/calculations/cabin-mass-offset">
			<function>
				<sum>
					<property>/systems/pressurization/calculations/cabin-mass-offset</property>
					<product>
						<property>/systems/air-conditioning/mass-flow-total-kg_s</property>
						<property>simulation/channel-dt</property>
					</product>
					<product>
						<property>-/systems/pressurization/calculations/outflow-total-kg_s</property>
						<property>simulation/channel-dt</property>
					</product>
				</sum>
			</function>
		</fcs_function>
		
		<fcs_function name="/systems/pressurization/cabin-pressure-psi">
			<function>
				<product>
					<v>0.00014503768</v>
					<quotient>
						<product>
							<property>/systems/pressurization/calculations/cabin-mass-kg</property>
							<v>287.058</v>
							<property>/systems/air-conditioning/temperatures/cabin-overall-temp-kelvin</property>
						</product>
						<v>330</v>
					</quotient>
				</product>
			</function>
		</fcs_function>
		
		<fcs_function name="/systems/pressurization/cabin-altitude">
			<function>
				<product>
					<quotient>
						<product>
							<sum>
								<pow>
									<quotient>
										<v>1013.25</v>
										<product>
											<property>/systems/pressurization/cabin-pressure-psi</property>
											<v>68.9476</v>
										</product>
									</quotient>
									<v>0.19022256039</v>
								</pow>
								<v>-1</v>
							</sum>	
							<sum>
								<v>273.15</v>
								<property>/systems/air-conditioning/temperatures/cabin-overall-temp-kelvin</property>
							</sum>
						</product>
						<v>0.0065</v>
					</quotient>
					<v>1.450376807</v>
				</product>
			</function>
		</fcs_function>
		
		<switch name="/systems/pressurization/calculations/cabin-rate-c1">
			<default value="1"/>
			<test value="100">
				/sim/time/elapsed-sec lt 10
			</test>
		</switch>
		
		<washout_filter name="/systems/pressurization/calculations/cabin-rate-fps">
			<input>/systems/pressurization/cabin-altitude</input>
			<c1>/systems/pressurization/calculations/cabin-rate-c1</c1>
		</washout_filter>
		
		<fcs_function name="/systems/pressurization/cabin-rate-fpm">
			<function>
				<product>
					<v>60</v>
					<property>/systems/pressurization/calculations/cabin-rate-fps</property>
				</product>
			</function>
		</fcs_function>
	</channel>
	
</system>
